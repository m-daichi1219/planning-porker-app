# AWS CDKスナップショットテスト利用方針

## 1. 概要

スナップショットテストは、インフラ構成の変更を検知し、意図しない変更を防止するための重要な仕組みです。このドキュメントでは、AWS CDKを使用したプロジェクトにおけるスナップショットテストの効果的な運用方法を定義します。

## 2. スナップショット変更の取り扱い

### 2.1 変更原因の調査

スナップショットテストが失敗した場合は、まず変更内容を調査します：

- **意図的な変更**：リソース追加、設定変更など、コードに手を加えた結果
- **意図しない変更**：外部ライブラリのアップデート、環境依存値の変化

```typescript
// 例: Lambda関数のランタイム変更（意図的な変更の例）
return new lambda.Function(this, id, {
  // 変更前: runtime: lambda.Runtime.NODEJS_18_X,
  runtime: lambda.Runtime.NODEJS_22_X, // 新しいランタイムに更新
  handler: "index.handler",
  // ... その他の設定
});
```

### 2.2 スナップショット更新の判断基準

スナップショットを更新するのは、次の場合に限ります：

- CDKの仕様変更による意図的な変更
- 新たなリソースの追加・削除
- リソース設定の意図的な変更（例：Lambdaランタイムの更新）

## 3. 開発ワークフロー

### 3.1 ローカル開発環境でのプロセス

1. **コード変更とテスト実行**：

   ```bash
   # テスト実行
   npm run test
   ```

2. **差分確認**：
   スナップショットテスト失敗時は、差分を確認して意図的な変更か検証

3. **スナップショット更新**（意図的な変更の場合）：

   ```bash
   # 専用のスナップショット更新コマンド
   npm run test:snapshot

   # または特定のテストファイルのみ更新
   npm run test -- -u backend.test.ts
   ```

   > **注**: `test:snapshot`コマンドは`vitest run -u`を実行し、すべてのスナップショットを更新します。特定のテストファイルのみ更新する場合は、上記の2番目または3番目の方法を使用してください。

4. **コミット**：
   更新されたスナップショットファイルと変更内容を一緒にコミット
   ```bash
   git add .
   git commit -m "Lambda関数のランタイムをNode.js 22.xに更新"
   ```

### 3.2 プルリクエスト運用

- **差分確認の徹底**：
  スナップショットファイルの差分を必ずレビュー
- **更新レビュー**：
  スナップショット更新を含むPRでは、変更が意図的かレビューで確認

```diff
// スナップショットの差分例
-  "Runtime": "nodejs18.x",
+  "Runtime": "nodejs22.x",
```

## 4. CI連携

### 4.1 CI環境での扱い

- CI（GitHub Actions）では常に最新スナップショットとの一致をチェック
- スナップショットの自動更新は行わない
- テスト失敗時は開発者に手動確認を促す

### 4.2 CI失敗時の対応フロー

1. ローカルでテスト実行
2. 変更内容の検証
3. 必要に応じてスナップショット更新
4. 更新後再度プッシュ

## 5. 更新のベストプラクティス

### 5.1 効果的な更新タイミング

- 計画的なリファクタリング時
- 新機能追加時
- インフラ構成の意図的な変更時

### 5.2 更新によるメリット

- テスト結果の安定性確保
- 意図しない変更の早期発見
- インフラ変更の透明性向上

## 6. トラブルシューティング

### 6.1 よくある問題

- **環境依存の値による失敗**：
  タイムスタンプやランダムな値はモックで固定値化

- **リージョン依存の設定変更**：
  テスト環境では特定リージョンに固定するか、マッチャーを使用

```typescript
// マッチャーを使用した柔軟な検証例
template.hasResourceProperties("AWS::Lambda::Function", {
  Runtime: Match.stringLikeRegexp("nodejs"),
});
```

### 6.2 解決手順

1. 差分内容を特定
2. 意図的な変更か確認
3. 意図的な場合はスナップショット更新
4. 意図しない場合は原因調査と修正
