# AWS インフラストラクチャ リリース設計

## 1. ローカル端末からのデプロイ

### 1.1 手段

AWS CDK CLI を利用して開発者のローカル環境からデプロイを実行します。開発者は AWS CDK CLI をインストールし、`cdk deploy` コマンドを実行してアプリケーション（スタック）をデプロイします。

CI/CD パイプラインを構築する前の段階や、スタンドアロンの開発環境で利用できます。ローカルでアプリケーションの動作や CloudFormation テンプレート内容を確認しながら、手動でデプロイを実施することが可能です。

### 1.2 メリット

- **即時性と柔軟性**:
  開発中に迅速に変更を反映できるため、試行錯誤しながらインフラの変更やリソースの動作確認が可能です。

- **詳細なログ確認**:
  ローカルで実行する場合、詳細なログやエラーメッセージを直接確認できるので、トラブルシューティングが容易です。

- **環境変数・認証情報の柔軟な管理**:
  AWS CLI と同様に、開発用の認証情報（`~/.aws/credentials` など）を利用できるので、環境ごとにカスタマイズが可能です。

### 1.3 デメリット／注意点

- **セキュリティのリスク**:
  ローカル端末に認証情報がセットアップされているため、認証情報の管理に注意が必要です。特に共有端末や複数人開発の場合、個々の AWS 認証情報の取り扱いに気を付ける必要があります。

- **環境の不整合**:
  ローカル環境の設定やネットワーク設定、SDK のバージョンなどにより、本番と異なる動作になるリスクがあります。

  > 可能であれば、開発用、ステージング、本番環境それぞれの設定を分離し、環境ごとに切り替えられる仕組みを検討してください。

- **再現性とスクリプトの管理**:
  手動実行の場合、コマンドやパラメータの取り違えなどによるヒューマンエラーに注意が必要です。
  > スクリプトや Makefile、npm scripts により、統一した実行手順を用意しておくと良いでしょう。

### 1.4 具体例

AWS CLI の設定が適切に行われていることを前提とします。

```bash
# CloudFormation テンプレートの生成・確認
cdk synth

# スタックのデプロイ
cdk deploy
```

package.json 内にスクリプトとして登録することで、以下のように一発で実行できるようにするのも効果的です。

```json
{
  "scripts": {
    "cdk:synth": "cdk synth",
    "cdk:deploy": "cdk deploy"
  }
}
```

## 2. Github Actions を用いた CD でのデプロイ

### 2.1 手段

Github Actions を用いて、GitHub 上でのコード変更をトリガーに自動的にデプロイを行う方法です。

#### Github Actions Workflow の構築

ワークフロー内で AWS 認証情報を Github Secrets に設定し、CDK CLI を利用したデプロイジョブを実行します。
例えば、`aws-actions/configure-aws-credentials` という公式アクションを利用して、認証情報を設定した後、`cdk deploy` を実行します。

#### ステージング／本番環境の切り分け

ブランチごとに異なる AWS アカウントやリージョン、スタックをデプロイする場合、ワークフローや CDK の context で環境を切り替える仕組みを実装することが望ましいです。

### 2.2 メリット

- **自動化と一貫性**:
  コード変更に応じて自動的にデプロイが実行されるため、手動作業が不要になりヒューマンエラーが減少します。また、検証プロセス（テスト・レビュー）をパイプラインに組み込むことで、一貫性のあるデプロイが可能です。

- **変更履歴の管理**:
  Github Actions のログや履歴でデプロイの実行記録を確認できるため、過去のデプロイ状況やエラーの追跡が容易です。

- **CI/CD と連携**:
  ユニットテストやスナップショットテストと連動し、テストが全てパスした場合のみデプロイを実施するなどの自動化フローを構築できます。

### 2.3 デメリット／注意点

- **認証情報の管理**:
  Github Secrets を利用して AWS 認証情報（アクセスキー、シークレットキーなど）を安全に管理する必要があります。

  > Secrets の露出や誤設定に注意し、必要最小限の権限（最小権限の原則）を適用することが重要です。

- **タイミングと並行性**:
  ワークフローの実行タイミングによっては、同時に複数のデプロイジョブが走る可能性があります。

  > リソースのコンフリクトを防ぐため、ジョブ間の依存関係や同時実行制御（例えば、ジョブキューや手動承認ステップの導入）を検討します。

- **失敗時のリカバリ**:
  自動デプロイでエラーが発生した場合の対応フロー（ロールバック、手動介入など）をあらかじめ設計しておく必要があります。
  > 自動ロールバックやアラート設定を導入することで、運用上のトラブル対応を迅速化できます。

### 2.4 具体例（Github Actions ワークフロー）

```yaml
name: Deploy CDK Stack
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install dependencies
        run: npm install

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Bootstrap CDK (if necessary)
        run: npx cdk bootstrap

      - name: Deploy CDK Stack
        run: npx cdk deploy --require-approval never
```

## 3. ポイントまとめ

### 3.1 認証情報のセキュアな管理

- Github Secrets を利用し、最小権限の IAM ポリシーを設定する。

### 3.2 環境ごとの設定

- ブランチやタグ、パラメータによって、デプロイ先の環境を動的に切り替えられるように工夫する。

### 3.3 テストとの連携

- 自動デプロイ前に必ずユニットテストやスナップショットテストなどを実行し、変更の正当性を検証する。

### 3.4 並行デプロイの制御

- 重要なリソースに対する同時実行の衝突を防ぐために、ジョブ制御や承認ステップを検討する。

## 4. 結論

### 4.1 ローカル端末からのデプロイ

- **手段**: AWS CDK CLI（`cdk deploy`）を利用
- **メリット**: 即時性、詳細ログ確認、開発環境に合わせた柔軟な認証設定
- **デメリット/注意点**: 認証情報の管理、環境間の不整合リスク、ヒューマンエラーによる実行ミス

### 4.2 Github Actions を用いた CD でのデプロイ

- **手段**: Github Actions ワークフロー内で `aws-actions/configure-aws-credentials` と CDK CLI を利用して自動デプロイ
- **メリット**: 自動化、一貫性あるデプロイ管理、履歴のトラッキング、テストとの連動
- **デメリット/注意点**: Secrets 管理、同時実行時の競合、失敗時のリカバリ対応、環境ごとのパラメータ管理

どちらの手段も、それぞれの開発段階や運用フェーズによって使い分けるのが望ましく、例えば日常的な試作や小さな変更はローカルで実施し、主要な変更や本番環境へのリリース時には Github Actions を用いた自動化パイプラインを動かす、といったハイブリッドな運用が有効です。
