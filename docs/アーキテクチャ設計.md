# Planning Poker Webアプリ AWSアーキテクチャ設計

## 1. 方針

### アプリケーション要件

Planning Poker APPは、見積もり手法のPlanning Pokerをオンラインで実施できるWebアプリケーションです。チームメンバーが各自の見積もりを匿名で提出し、リアルタイムで結果を共有することで、認識の違いや不確実性を明確にします。

### 非機能要件

#### 可用性

- システムは高い可用性を確保し、主要な機能が常に利用可能であること。
- マネージドサービスを活用し、耐障害性を向上させる。
- 単一障害点を排除し、障害時に迅速に対応可能な設計を行う。

#### 性能／拡張性

- ユーザー数増加に応じてスケール可能な構成を選定。
- 通信の低遅延を実現する仕組みを検討。
- 高トラフィック時のパフォーマンス劣化を防止する。

#### 運用／保守性

- Infrastructure as Code (IaC) を採用し、インフラ管理の効率化を図る。
- アプリケーションとインフラのログ・メトリクスを収集・監視し、異常を検知可能にする。
- デプロイ作業を自動化し、運用負荷を軽減する。

#### 移行性

- 特定のクラウドに依存しすぎない設計を検討。
- 必要に応じて別のクラウドや環境に移行可能なアーキテクチャを目指す。

#### セキュリティ

- 最小権限の原則に基づき、アクセス制御を行う。
- ユーザー識別情報を用いてアクセスを制限し、不正アクセスを防止する。
- 通信の暗号化を行い、データの保護を実施する。

#### 耐障害性

- データ損失を防ぐためのバックアップ戦略を検討。
- 主要コンポーネントを複数の可用性ゾーンで稼働させる。
- データ消失や誤削除に備えた保護機構を実装。

## 2. 基本設計

Planning Poker アプリケーションの各要素をAWSインフラにマッピングし、要件を満たす構成を設計します。

### ① アーキテクチャ概要

- **フロントエンド**
  - Vue 3 + TypeScript で構築
  - 静的ホスティングを利用し、コンテンツを提供
  - バージョニングとデータ消失防止の仕組みを適用
- **バックエンド**
  - サーバーレスアーキテクチャでAPIを提供
  - ルーム情報をJSON形式でデータストアに保存
- **リアルタイム通信**
  - リアルタイムな投票を管理する仕組みを構築
- **認証**
  - ログイン不要。URLによるアクセス制御（UUID で一意なルーム識別子を生成）
- **インフラ管理**
  - Infrastructure as Code (IaC) により構築・管理を自動化

### ② AWSサービスの選定

- **フロントエンド**: 静的ホスティング、CDN
- **API**: サーバーレス関数
- **リアルタイム通信**: WebSocket API
- **データストレージ**: JSON形式でデータを保存
- **アクセス管理**: IAM
- **Infrastructure as Code**: AWS CDK
- **ログ・監視**: 監視ツールを利用したログ管理

## 3. 詳細設計

### ① アーキテクチャ図

```
[ User ] --(HTTPS)--> [ CDN ] --> [ S3 (静的ホスティング) ]
                                │
                                ▼
               [ WebSocket API ] --> [ Lambda (API)]
                                 │
                                 ▼
                      [ S3 (ルーム情報 JSON)]
```

### ② 各コンポーネント設計

- **S3 (フロントエンド)**: Vue.jsビルドをデプロイ
  - バージョニングとデータ削除防止を有効化
- **CDN**: HTMLは短く、静的リソースは長めにキャッシュ
- **WebSocket API**: ルーム作成、投票のリアルタイム送受信を実装
- **Lambda (API処理)**:
  - ルーム作成・参加・投票のロジック実装
  - ルーム情報をS3にJSON形式で保存
  - S3からデータを読み込み投票結果を提供
- **S3 (データ保存)**:
  - ルームごとにJSON形式で情報を保存
  - ファイル名: `{roomId}.json`
  - データのライフサイクル管理を行い、アーカイブや自動削除を管理
- **IAM (権限管理)**: 必要最小限の権限を付与
- **ログ・監視**:
  - Lambdaログを収集し、アプリケーションの利用状況を監視
  - 実行回数、エラー数、レイテンシーを監視し、アラートを設定
- **デプロイ (CI/CD)**: GitHub Actions で CDK デプロイを自動化

### ③ URL設計

- `/` : ホーム画面 (GET)
- `/room/:roomId` : ルームへの参加 (GET)
- `/api/create-room` : ルームの作成 (POST)
- `/api/vote` : 投票情報を送信 (POST, WebSocket)
- `/api/results` : 投票結果を取得 (GET, WebSocket)

### ④ セキュリティ設計

- **WebSocketセキュリティ**: UUIDによるルーム識別でアクセス制御
- **IAMポリシー**: 必要なリソースにのみアクセス許可
- **HTTPS強制**: HTTPアクセスはHTTPSにリダイレクト
