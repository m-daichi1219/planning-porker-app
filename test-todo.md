# 追加推奨テスト項目 (テスト TODO)

このドキュメントは、アプリケーションの品質と信頼性を向上させるために追加が推奨されるテスト項目をまとめたものです。

## バックエンド (`apps/backend`)

### 1. Lambda関数ロジックの単体テスト (Vitest)

- **必要性**:
  - 各Lambdaハンドラ内のビジネスロジック（入力検証、処理分岐、外部サービス呼び出しなど）の正当性を個別に検証するため。
  - CDKスナップショットテストではカバーできない、関数の詳細な振る舞いを保証するため。
  - リファクタリング時のデグレードを早期に検出し、保守性を向上させるため。
- **網羅範囲**:
  - `connect/index.ts`: 接続リクエスト処理、必須パラメータ（roomId）の検証、S3への接続情報保存ロジック（実装後）。
  - `disconnect/index.ts`: 切断リクエスト処理、S3からの接続情報削除ロジック（実装後）。
  - `default/index.ts`:
    - メッセージボディのパースとアクションディスパッチ処理。
    - 各アクション (`vote`, `reveal_votes`, `reset_votes`) の個別のロジック。
      - 期待される入力に対する処理の実行。
      - S3へのデータ操作（投票データの保存、取得、リセットなど）（実装後）。
      - 他のクライアントへのメッセージ送信処理の呼び出し（モックを使用）。
    - 不正なアクションやデータフォーマットに対するエラーハンドリング。
- **備考**: S3サービスクラスやApiGatewayManagementApiなどをモックしてテストします。

### 2. WebSocket API 統合テスト (Vitest + WebSocketクライアント or aws-sdk)

- **必要性**:
  - WebSocket接続からメッセージ送受信、Lambda関数による処理、クライアントへのレスポンス返却までの一連の流れを結合して検証するため。
  - 単体テストでは見つけにくい、モジュール間の連携不備や設定ミスを発見するため。
  - リアルタイムメッセージング機能全体の信頼性を確保するため。
- **網羅範囲**:
  - クライアントからのWebSocket接続確立。
  - クライアントからの各種アクションメッセージ (`vote`, `reveal_votes`, `reset_votes`など) の送信。
  - 対応するLambdaハンドラがトリガーされ、期待通りに処理が実行されること。
  - 処理結果が、メッセージを送信したクライアントや、ルーム内の他のクライアントに正しくブロードキャストされること（ApiGatewayManagementApiのモックまたは実際のAPIコール検証）。
  - 接続切断処理と、それに伴う後処理の検証。
- **備考**: ローカル環境またはテスト用AWS環境で実際にAPIをデプロイしてテストするか、`ApiGatewayManagementApi` の `postToConnection` をモックし、呼び出し引数や回数を検証します。

## フロントエンド (`apps/frontend`)

### 1. 単体テスト/コンポーネントテスト (Vitest + Vue Test Utils)

- **必要性**:
  - UIコンポーネントの表示ロジック、ユーザーインタラクション、propsやイベントの処理が期待通りに動作することを個別に検証するため。
  - コンポーザブル関数や状態管理ストアのロジックの正当性を保証するため。
  - E2Eテストよりも高速かつ詳細に問題を特定し、開発効率とコード品質を向上させるため。
  - CIでのフロントエンドテストを有効化し、継続的な品質担保を実現するため。
- **網羅範囲**:
  - **Vueコンポーネント**:
    - `CreateRoom.vue`: 初期表示、入力フィールドの動作、ルーム作成ボタンクリック時のイベント発行など。
    - 投票画面関連コンポーネント: 投票選択肢の表示、投票実行時のイベント発行、他ユーザーの投票状況の表示（モックデータ使用）など。
    - 結果表示コンポーネント: 投票結果の正しい表示、リセットボタンの動作など。
    - 共通UIコンポーネント（ボタン、モーダルなど）。
  - **コンポーザブル関数**:
    - `useCreateRoom.ts`: ルーム作成API呼び出し（モック）、成功・失敗時の状態遷移など。
    - WebSocket通信を扱うコンポーザブル（実装後）: メッセージ送受信ロジック、状態更新など。
  - **状態管理ストア (Piniaなど)**:
    - アクションのディスパッチと、それに伴うstateの変更。
    - ゲッターによるstateの正しい取得。
    - 非同期アクションの処理（API呼び出しモック）。
  - **ユーティリティ関数**: 各種ヘルパー関数の入力に対する期待される出力。
- **備考**: API呼び出しやWebSocket通信はモックします。Vue Test Utils を活用してコンポーネントのマウント、操作、アサーションを行います。

## E2Eテスト (`apps/e2e`)

### 1. 主要シナリオの拡充 (Playwright)

- **必要性**:
  - ユーザーが実際にアプリケーションを操作する一連のフローが、フロントエンドからバックエンドまで含めて正しく動作することを保証するため。
  - `createRoom` 以外の主要なユースケース（投票、結果表示、リセット）を網羅するため。
  - 複数ユーザーが関わるリアルタイムなインタラクションを検証するため。
- **網羅範囲**:
  - **投票シナリオ**:
    1.  ユーザーAが部屋を作成。
    2.  ユーザーBが同じ部屋に参加。
    3.  ユーザーAとBがそれぞれ異なる投票を行う。
    4.  投票結果表示アクションが実行され、両ユーザーの画面に正しい集計結果が表示される。
    5.  投票リセットアクションが実行され、両ユーザーの画面がリセットされる。
  - **複数ユーザー参加シナリオ**: 複数のユーザーが同じ部屋に正常に参加でき、各ユーザーの画面に他の参加者が表示されること。
  - **エラーハンドリングシナリオ**:
    - 存在しない部屋IDで参加しようとした場合の適切なエラー表示。
    - サーバー側でエラーが発生した場合のフロントエンドでのフォールバック表示（可能な範囲で）。
    - 投票時の不正な入力に対するバリデーションとフィードバック。
- **備考**: Playwright の複数ブラウザコンテキスト機能やページオブジェクトモデルを活用して、テストの可読性と保守性を高めます。

---

このTODOリストを参考に、テスト戦略を段階的に強化していくことをお勧めします。
まずはフロントエンドの単体テスト基盤の整備と、バックエンドの主要Lambda関数の単体テストから着手するのが効果的でしょう。
